name: Upload UiPath Package

on:
  push:
    branches: [main]

env:
  UIPATH_CLIENT_ID: 21a6955b-2fbe-4cd4-8d71-4124dff739ce
  UIPATH_CLIENT_SECRET: 1ljhMu$Db!6boY6W
  UIPATH_ACCOUNT_LOGICAL_NAME: testbfsvyha
  UIPATH_TENANT: DefaultTenant
  UIPATH_ORCH_URL: https://cloud.uipath.com

jobs:
  upload-package:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate and get token
        id: auth
        shell: pwsh
        run: |
          $clientId = "21a6955b-2fbe-4cd4-8d71-4124dff739ce"
          $clientSecret = "1ljhMu`$Db!6boY6W"  # Escape `$ for PowerShell
          $scope = "OR.Jobs"
          $body = "grant_type=client_credentials&client_id=$clientId&client_secret=$clientSecret&scope=$scope"
          $response = Invoke-RestMethod -Uri "https://cloud.uipath.com/identity_/connect/token" `
            -Method Post `
            -Body $body `
            -ContentType "application/x-www-form-urlencoded"
          $token = $response.access_token
          Write-Output "::add-mask::$token"
          echo "::set-output name=token::$token"

      - name: Upload .nupkg package to Orchestrator
        shell: pwsh
        env:
          ORCH_TOKEN: ${{ steps.auth.outputs.token }}
        run: |
          $packagePath = "C:\Users\Saiteja.Indarapu\.nuget\packages\testautomationproject\1.0.202204889\testautomationproject.1.0.202204889.nupkg"

          if (-Not (Test-Path $packagePath)) {
            Write-Error "Package file not found at $packagePath"
            exit 1
          }

          Write-Output "Uploading package: $packagePath"

          Invoke-RestMethod -Uri "https://cloud.uipath.com/odata/Packages/UiPath.Server.Configuration.OData.UploadPackage" `
            -Method Post `
            -Headers @{ Authorization = "Bearer $env:ORCH_TOKEN" } `
            -InFile $packagePath `
            -ContentType "application/octet-stream"

          Write-Output "âœ… Package upload completed"
